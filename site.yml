---
- hosts: localhost
  vars_files:
  - settings.yaml
  pre_tasks:
    - name: gather facts from all servers
      setup:
      delegate_to: "{{item}}"
      delegate_facts: True
      loop: "{{ groups['all'] }}"
      tags:
        - worker
  roles:
    - pki
  tags:
    - init

- hosts: all
  vars_files:
  - settings.yaml
  become: yes
  roles:
    - common

- hosts: controllers
  vars_files:
  - settings.yaml
  become: yes
  roles:
    - etcd
  tags:
    - etcd
    - control

- hosts: loadbalancers
  vars_files:
  - settings.yaml
  become: yes
  roles:
    - traefik
  tags:
    - proxy
    - loadbalancers

- hosts: controllers
  vars_files:
  - settings.yaml
  become: yes
  roles:
    - controller
  tags:
    - controller

- hosts: workers
  vars_files:
  - settings.yaml
  become: yes
  roles:
    - worker
  tags:
    - worker